version: '3.8'

services:
  webrtc-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexusdialer-webrtc-gateway
    restart: unless-stopped
    ports:
      - "3005:3005"
      - "10000-10100:10000-10100/udp"
    environment:
      - NODE_ENV=production
      - PORT=3005
      - HOST=0.0.0.0
      - CORS_ORIGIN=http://localhost:3000
      - MEDIASOUP_WORKERS=2
      - MEDIASOUP_LOG_LEVEL=warn
      - RTC_MIN_PORT=10000
      - RTC_MAX_PORT=10100
      - WEBRTC_LISTEN_IP=0.0.0.0
      - WEBRTC_ANNOUNCED_IP=${WEBRTC_ANNOUNCED_IP:-127.0.0.1}
      - FREESWITCH_HOST=${FREESWITCH_HOST:-freeswitch}
      - FREESWITCH_PORT=5060
      - FREESWITCH_WS_URL=${FREESWITCH_WS_URL:-ws://freeswitch:8081}
      - FREESWITCH_ESL_PASSWORD=${FREESWITCH_ESL_PASSWORD:-ClueCon}
      - LOG_LEVEL=info
    networks:
      - nexusdialer
    depends_on:
      - freeswitch
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/api/webrtc/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  freeswitch:
    image: drachtio/drachtio-freeswitch-mrf:latest
    container_name: nexusdialer-freeswitch
    restart: unless-stopped
    ports:
      - "5060:5060/tcp"
      - "5060:5060/udp"
      - "8081:8081"
      - "16384-16484:16384-16484/udp"
    environment:
      - MOD_AUDIO_FORK=true
    networks:
      - nexusdialer
    volumes:
      - freeswitch-data:/usr/local/freeswitch/storage
      - freeswitch-recordings:/usr/local/freeswitch/recordings

networks:
  nexusdialer:
    name: nexusdialer
    driver: bridge

volumes:
  freeswitch-data:
  freeswitch-recordings:
